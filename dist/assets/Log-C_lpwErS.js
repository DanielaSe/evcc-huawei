import{_ as h,j as L,c as i,a as s,k as p,o as r,b as g,n as m,q as v,t as u,w as $,K as C,F as f,r as w,d as V,h as I,O as y,a1 as E,e as d,i as B}from"./index-CN0w41DB.js";import{T as F}from"./TopHeader-C6w4H9P6.js";import{M as H}from"./MultiSelect-ByDpfYrz.js";import"./TopNavigation-BCd9W1gB.js";import"./deepEqual-DB6L2s-b.js";var U='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path d="M0 0h48v48H0z" fill="none"/><path d="M22 4v19.172l-8-8L11.171 18 24 30.828 36.829 18 34 15.172l-8 8V4z"/><path d="M8 44h32c2.206 0 4-1.794 4-4V30h-4v10H8V30H4v10c0 2.206 1.794 4 4 4z"/></svg>';class R extends HTMLElement{connectedCallback(){this.setAttribute("data-shopicon",!0),this.innerHTML=U}}window.customElements.define("shopicon-regular-download",R);const z={name:"Play",mixins:[L]};function D(e,t,o,n,c,l){return r(),i("svg",{style:p(e.svgStyle),viewBox:"0 0 24 24"},t[0]||(t[0]=[s("path",{fill:"currentColor",d:"M8 17.175V6.825q0-.425.3-.713t.7-.287q.125 0 .263.037t.262.113l8.15 5.175q.225.15.338.375t.112.475t-.112.475t-.338.375l-8.15 5.175q-.125.075-.262.113T9 18.175q-.4 0-.7-.288t-.3-.712m2-1.825L15.25 12L10 8.65z"},null,-1)]),4)}const N=h(z,[["render",D]]),O={name:"Record",mixins:[L]};function P(e,t,o,n,c,l){return r(),i("svg",{style:p(e.svgStyle),viewBox:"0 0 24 24"},t[0]||(t[0]=[s("path",{fill:"currentColor",d:"M12 17q-2.075 0-3.537-1.463T7 12t1.463-3.537T12 7t3.538 1.463T17 12t-1.463 3.538T12 17m8-5q0-1.05-.25-2.025t-.725-1.85q-.2-.375-.162-.8t.387-.675t.775-.15t.625.45q.65 1.125 1 2.388T22 12t-.363 2.675t-1.012 2.4q-.2.35-.612.438t-.763-.163t-.4-.675t.15-.8q.475-.875.738-1.838T20 12m-8-8q-1.075 0-2.037.263T8.125 5q-.375.2-.8.15t-.675-.4t-.162-.763t.437-.612q1.125-.65 2.4-1.012T12 2t2.675.363t2.4 1.012q.375.2.463.613t-.163.762t-.675.4t-.8-.15q-.875-.475-1.85-.737T12 4m-8 8q0 1.075.263 2.038T5 15.875q.2.375.15.8t-.4.675t-.763.163t-.612-.438q-.65-1.125-1.012-2.4T2 12t.35-2.662t1-2.388q.2-.35.625-.45t.775.15t.388.675t-.163.8Q4.5 9 4.25 9.975T4 12m8 8q1.05 0 2.025-.25t1.85-.725q.375-.2.788-.15t.662.4t.163.763t-.438.612q-1.125.65-2.387 1T12 22t-2.662-.35t-2.388-1q-.35-.2-.45-.625t.15-.775t.675-.387t.8.162q.875.475 1.85.725T12 20"},null,-1)]),4)}const Q=h(O,[["render",P]]),T=["fatal","error","warn","info","debug","trace"],b="debug",x=1e3,j=new RegExp("\\[.*?\\] (".concat(T.map(e=>e.toUpperCase()).join("|"),")")),K={name:"Log",components:{TopHeader:F,Play:N,Record:Q,MultiSelect:H},props:{areas:{type:Array,default:()=>[]},level:{type:String,default:b}},data(){return{lines:[],availableAreas:[],search:"",timeout:null,levels:T,busy:!1}},computed:{filteredLines(){return this.lines.filter(e=>!this.search||e.toLowerCase().includes(this.search.toLocaleLowerCase()))},lineEntries(){const e=new Map;return this.filteredLines.map(t=>{var l;let o=t.substring(0,50);const n=e.get(o)||0;e.set(o,n+1),o="".concat(o,"-").concat(n+1);const c="log log-".concat(((l=j.exec(t))==null?void 0:l[1].toLowerCase())||"none");return{key:o,className:c,line:t}})},areaOptions(){return this.availableAreas.map(e=>({name:e,value:e}))},areasLabel(){return this.areas.length===0?this.$t("log.areas"):this.areas.length===1?this.areas[0]:this.$t("log.nAreas",{count:this.areas.length})},showMoreButton(){return this.lines.length===x},updateInterval(){var e;return(((e=E.state)==null?void 0:e.interval)||10)*1e3},downloadUrl(){const e=new URLSearchParams;return this.level&&e.append("level",this.level),this.areas.forEach(t=>{e.append("area",t)}),e.append("format","txt"),"./api/system/log?".concat(e.toString())},autoFollow(){return this.timeout!==null}},watch:{areas(){this.updateLogs()},level(){this.updateLogs()}},mounted(){this.startInterval(),this.updateAreas()},unmounted(){this.stopInterval()},methods:{async updateLogs(e){var t;if(!this.busy){try{this.busy=!0;const o=await y.get("/system/log",{params:{level:this.level||null,area:this.areas.length?this.areas:null,count:e?null:x}});this.lines=((t=o.data)==null?void 0:t.result)||[],this.$nextTick(()=>{e?this.scrollToTop():this.scrollToBottom()})}catch(o){console.error(o)}this.busy=!1}},startInterval(){this.stopInterval(),this.updateLogs(),this.timeout=setInterval(()=>{this.updateLogs()},this.updateInterval)},stopInterval(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null)},async updateAreas(){var e;try{const t=await y.get("/system/log/areas");this.availableAreas=((e=t.data)==null?void 0:e.result)||[]}catch(t){console.error(t)}},onScroll(e){this.autoFollow&&e.target.scrollTop+e.target.clientHeight<e.target.scrollHeight&&this.stopInterval()},scrollToTop(){this.$refs.log.scrollTop=0},scrollToBottom(){this.$refs.log.scrollTop=this.$refs.log.scrollHeight},toggleAutoFollow(){this.autoFollow?this.stopInterval():(this.scrollToBottom(),this.startInterval())},updateQuery({level:e,areas:t}){let o=e||this.level,n=t||this.areas;o===b&&(o=void 0),n=n.length?n.join(","):void 0,this.$router.push({query:{level:o,areas:n}})},changeLevel(e){this.updateQuery({level:e.target.value})},changeAreas(e){this.updateQuery({areas:e})}}},G={class:"root safe-area-inset"},J={class:"container d-flex h-100 flex-column px-0 pb-4"},W={class:"logs d-flex flex-column overflow-hidden flex-grow-1 px-4 mx-2 mx-sm-4"},X={class:"flex-grow-0 row py-4"},Y={class:"col-6 col-lg-3 mb-4 mb-lg-0 d-flex gap-2"},Z={class:"btn-group w-100 w-lg-auto d-flex"},ee={class:"text-nowrap text-truncate"},te=["aria-label","href"],le={class:"col-6 offset-lg-1 col-lg-4 mb-4 mb-lg-0"},se=["placeholder"],oe={class:"filterLevel col-6 col-lg-2"},ae=["aria-label","value"],re=["value"],ne={class:"filterAreas col-6 col-lg-2"},ie={key:0,class:"my-2"},ce={key:1,class:"d-block evcc-default-text flex-grow-1","data-testid":"log-content"},ue={key:2,class:"my-4"};function de(e,t,o,n,c,l){const _=d("TopHeader"),q=d("Record"),A=d("Play"),k=d("MultiSelect");return r(),i("div",G,[s("div",J,[g(_,{title:e.$t("log.title"),class:"mx-4"},null,8,["title"]),s("div",W,[s("div",X,[s("div",Y,[s("div",Z,[s("button",{type:"button",class:m(["btn text-nowrap d-flex gap-2 flex-grow-1 text-nowrap text-truncate",l.autoFollow?"btn-secondary":"btn-outline-secondary"]),onClick:t[0]||(t[0]=(...a)=>l.toggleAutoFollow&&l.toggleAutoFollow(...a))},[s("span",ee,u(e.$t("log.update")),1),l.autoFollow?(r(),v(q,{key:0,ref:"spin",class:"spin flex-shrink-0",style:p({animationDuration:"".concat(l.updateInterval,"ms")})},null,8,["style"])):(r(),v(A,{key:1,class:"flex-shrink-0 play"}))],2),s("a",{class:"btn btn-outline-secondary flex-grow-0","aria-label":e.$t("log.download"),href:l.downloadUrl,download:""},t[6]||(t[6]=[s("shopicon-regular-download",{size:"s",class:"icon"},null,-1)]),8,te)])]),s("div",le,[$(s("input",{"onUpdate:modelValue":t[1]||(t[1]=a=>c.search=a),type:"search",class:"form-control search",placeholder:e.$t("log.search"),"data-testid":"log-search"},null,8,se),[[C,c.search]])]),s("div",oe,[s("select",{class:"form-select","aria-label":e.$t("log.levelLabel"),value:o.level,onInput:t[2]||(t[2]=(...a)=>l.changeLevel&&l.changeLevel(...a))},[(r(!0),i(f,null,w(c.levels,a=>(r(),i("option",{key:a,value:a},u(a.toUpperCase()),9,re))),128))],40,ae)]),s("div",ne,[g(k,{id:"logAreasSelect",modelValue:o.areas,options:l.areaOptions,selectAllLabel:e.$t("log.selectAll"),"onUpdate:modelValue":l.changeAreas,onOpen:t[3]||(t[3]=a=>l.updateAreas())},{default:V(()=>[B(u(l.areasLabel),1)]),_:1},8,["modelValue","options","selectAllLabel","onUpdate:modelValue"])])]),t[7]||(t[7]=s("hr",{class:"my-0"},null,-1)),s("div",{ref:"log",class:"overflow-y-scroll pt-2 pb-4 flex-grow-1 d-flex flex-column",onScroll:t[5]||(t[5]=(...a)=>l.onScroll&&l.onScroll(...a))},[l.showMoreButton?(r(),i("div",ie,[s("button",{class:"btn btn-link btn-sm evcc-default-text px-0",type:"button",onClick:t[4]||(t[4]=a=>l.updateLogs(!0))},u(e.$t("log.showAll")),1)])):I("",!0),l.filteredLines.length?(r(),i("code",ce,[(r(!0),i(f,null,w(l.lineEntries,({line:a,className:M,key:S})=>(r(),i("div",{key:S,class:m(M)},u(a),3))),128))])):(r(),i("p",ue,u(e.$t("log.noResults")),1))],544)])])])}const fe=h(K,[["render",de],["__scopeId","data-v-6a783ccb"]]);export{fe as default};
